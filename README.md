# MirageFuzz
## How to Build MirageFuzz
### Docker 
#### Build Image
```
cd <path_of_miragefuzz>
docker build . -t <image-name>
```
#### Use Image
```
docker run --name <container-name> -it --privileged --net=host <image-name> /bin/bash
```

### Script
After all the dependent library and environment are satisfied (please refer to Dockerfile).
```
cd <path_of_miragefuzz>
./build.sh 
```


## How to Build Benchmark
MirageFuzz provides a clang wrapper, namely `mirage-clang`.
Via configuring environment variable, `mirage-clang` can compile target benches with different compile modes.

Note that due to the immaturity of the implementation, `mirage-clang` is not possible to compile multiple benches at the same time, nor can it compile the same bench in parallel (`make -j`)

And it's recommended to execute command `mirage-clang init` to initialize edge id before building a benchmark.


### AFL MODE
In fact, this mode is equivalent to the instrumentation pattern in the llvm mode of AFL.

```
export USE_AFL=1
```

or

```
USE_AFL=1 <compile-command>
```

What's more, in AFL MODE, `mirage-clang` also supports LLVM Sanitizer by configuring extra environment variable.
- `USE_ASAN` :  activate address sanitizer to compile target.
- `USE_MSAN` :  activate memory sanitizer to compile target.

### SOURCE MODE
This mode is to compile the target executable used in `source fuzzing` mentioned in paper.
Not only can the edge coverage be detected, the target in this mode can also dynamically identify unexplored sibling edges.

```
export USE_SOURCE=1
```

or

```
USE_SOURCE=1 <compile-command>
```
### PHANTOM MODE
This mode is to compile the target executable used in `phantom fuzzing` mentioned in paper.
Not only can the edge coverage be detected, the target in this mode can also detect the coverage of those phantom edges.

```
export USE_PHANTOM=1
```

or

```
USE_PHANTOM=1 <compile-command>
```

### PIN MODE
This mode is to compile the target executable used in dynamic taint analysis mentioned in paper.
In fact, some blank function calls are implanted in the target program for PIN dynamic instrumentation.

And dynamic taint analysis is implemented by the `libdft` framework under PIN.

```
export USE_PIN=1
```

or

```
USE_PIN=1 <compile-command>
```


## How to fuzz

### Basic 2 process fuzzing

As mentioned in the paper, for a fuzzing task, `miragefuzz` requires at least two fuzz processes to cooperate with each other.

#### Prepare Executable

The first fuzz process, namely `source fuzzing`, needs the executable generated by SOURCE MODE `mirage-clang`.

The second fuzz process, namely `source fuzzing`, needs the executable generated by PHANTOM MODE `mirage-clang`.

Moreover, both of them requires the third exeuctable, which is generated by PIN MODE `mirage-clang` , to do taint analysis.

#### Do fuzzing
For `source fuzzing`: 
`mirage-fuzz -i <init-seeds-dir> -o <out-dir> -S source -D <pin-mode-target> <source-mode-target> [argvs]`

For `phantom fuzzing`:
`mirage-fuzz -E -i <init-seeds-dir> -o <out-dir> -S source -D <pin-mode-target> <phantom-mode-target> [argvs]`

Note that both `source fuzzing` and `phantom fuzzing` share the same `out-dir`.

### Recommended 3 process fuzzing
In the real fuzzing scene, it is recommended to add a third fuzzing process.

For this additional fuzzing process, the AFL MODE target is recommended because of the lower runtime cost of instrumentation and the more efficient detection of bugs with LLVM Sanitizer.

#### Prepare Executable

- SOURCE MODE target
- PHANTOM MODE target
- AFL MODE target, and optional ASAN/MSAN instrumention to augment bug detection.

#### Do fuzzing

For `source fuzzing`: 
`mirage-fuzz -i <init-seeds-dir> -o <out-dir> -S source -D <pin-mode-target> <source-mode-target> [argvs]`

For `phantom fuzzing`:
`mirage-fuzz -E -i <init-seeds-dir> -o <out-dir> -S source -D <pin-mode-target> <phantom-mode-target> [argvs]`

For the third fuzzing process:
`mirage-fuzz -E -i <init-seeds-dir> -o <out-dir> -S afl <afl-mode-target> [argvs]`

Note that all the three fuzzing processes share the same `out-dir`.

### More Fuzzing Pattern ...
In fact, as `miragefuzz` is built based on `afl-fuzz`, `miragefuzz` can be used like `afl-fuzz`.